services:
    redis:
        image: redis:7-alpine
        restart: unless-stopped
        # Port not exposed to host - only accessible within Docker network
        networks:
            - plant_stack

    api:
        build:
            context: .
            dockerfile: Dockerfile
        command: uvicorn main:app --host 0.0.0.0 --port 8000
        environment:
            PLANT_REDIS_URL: redis://redis:6379/0
        env_file:
            - .env
        depends_on:
            - redis
        ports:
            - "8000:8000"
        volumes:
            - ./data:/app/data
        networks:
            - plant_stack

    worker:
        build:
            context: .
            dockerfile: Dockerfile
        command: python -m app.workers.automation_worker_v2
        environment:
            PLANT_REDIS_URL: redis://redis:6379/0
        env_file:
            - .env
        depends_on:
            - redis
            - api
        volumes:
            - ./data:/app/data
        networks:
            - plant_stack

    sqlite-web:
        image: coleifer/sqlite-web
        restart: unless-stopped
        ports:
            - "8081:8080"
        volumes:
            - ./data:/data
        environment:
            SQLITE_DATABASE: /data/plant.db
        networks:
            - plant_stack

volumes:
    plant-db:

networks:
    plant_stack:
        driver: bridge
